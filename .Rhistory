"amp_nd10","amp_nd10_ris", "amp_nm", "amp_nm_ris",
"ctx_nd30", "ctx_nd30_ris", "ctx_nm", "ctx_nm_ris",
"col_nd10", "col_nd10_ris", "col_nm", "col_nm_ris",
"dor_nd10", "dor_nd10_ris", "dor_nm", "dor_nm_ris",
"nal_nd30", "nal_nd30_ris", "nal_nm", "nal_nm_ris",
"nit_nd300", "nit_nd300_ris","nit_nm", "nit_nm_ris")
#column name will be stored in a vector if the column is present in the result database
cols_present <- colnames(df_referred_raw[,intersect(abx_cols, colnames(df_referred_raw))])
cols_to_retain <- append(demogs_cols, cols_present)
# Subset df_referred_raw
df_referred_demogs <- subset(df_referred_raw, select = cols_to_retain) %>%
filter(accession_no %in% ac_list)
# Merge Demogs and WGS QC Result ----------------------------------------------------------------
df_kpn_wgs_demogs <- merge(df_referred_demogs, df_wgs_result, by = "accession_no", all = TRUE) %>%
relocate(wgs_file, batch_codes, results, .before = date_birth)
# Merge df_lab_kpn_monitoring and df_wgs_result ----------------------------------------------------------------
df_ghru_kpn_result <- merge(df_lab_kpn_monitoring, df_kpn_wgs_demogs, by = "accession_no", all = TRUE) %>%
rename(
wgs_result = results,
sequencing_result = result
) %>%
select(-year, -confirmed_id, -confirmed_age, -referred_ast, -extraction_date)
#edit format
df_ghru_kpn_result$date_received <- format(as.Date(df_ghru_kpn_result$date_received), "%Y-%m-%d")
df_ghru_kpn_result$sequencing_date <- format(as.Date(df_ghru_kpn_result$sequencing_date), "%Y-%m-%d")
df_ghru_kpn_result$referral_date <- format(as.Date(df_ghru_kpn_result$referral_date), "%Y-%m-%d")
# Add Laboratory Name ------------------------------------------
site_code <- c(
'APM' = 'Amai Pakpak Medical Center',
'BGH' = 'Baguio General Hospital and Medical Center',
'BRH' = 'Batangas Medical Center',
'BRT' = 'Bicol Regional Hospital and Medical Center',
'CMC' = 'Cotabato Regional Hospital and Medical Center',
'CRH' = 'Caraga Regional Hospital',
'CVM' = 'Cagayan Valley Medical Center',
'DLS' = 'De La Salle University Medical Center',
'DMC' = 'Southern Philippines Medical Center',
'EVR' = 'Eastern Visayas Medical Center',
'FEU' = 'FEU - NRMF Medical Center',
'GMH' = 'Gov. Celestino Gallares Memorial Regional Hospital',
'JLM' = 'Jose B. Lingad Memorial Regional Hospital',
'LCP' = 'Lung Center of the Philippines',
'MAR' = 'Mariano Marcos Memorial Hospital and Medical Center',
'MMH' = 'Corazon Locsin Montelibano Memorial Regional Hospital',
'NKI' = 'National Kidney and Transplant Institute',
'NMC' = 'Northern Mindanao Medical Center',
'ONP' = 'Ospital ng Palawan',
'PGH' = 'Philippine General Hospital',
'RMC' = 'Rizal Medical Center',
'RTH' = 'Dr. Rafael S. Tumbokon Memorial Hospital',
'RTM' = 'Research Institute for Tropical Medicine',
'SLH' = 'San Lazaro Hospital',
'STU' = 'University of Sto. Tomas Hospital',
'VSM' = 'Vicente Sotto Memorial Medical Center',
'ZMC' = 'Zamboanga City Medical Center',
'ZPH' = 'Zamboanga del Norte Medical Center'
)
df_ghru_kpn_result$laboratory_name <- site_code[df_ghru_kpn_result$laboratory]
# Add new columns based on condition ------------------------------------------
df_ghru_kpn_result$sex <- ifelse(df_ghru_kpn_result$sex == "f", "Female", "Male")
df_ghru_kpn_result$service_type <- ifelse(df_ghru_kpn_result$service_type == "In", "Inpatient", "Outpatient")
# Clean Ward Type Value ------------------------------------------
df_clean <- df_ghru_kpn_result
# Get unique laboratory values
unique_labs <- unique(df_clean$laboratory)
# Initialize an empty list to store ward data from each sheet
ward_list <- list()
# Loop through each laboratory value and read the corresponding sheet
for (lab in unique_labs) {
tryCatch({
# Read the sheet with the name matching the laboratory value
df_temp <- read_excel("2024_DATA_ward.xlsx", sheet = as.character(lab))
# Select required columns
df_temp <- subset(df_temp, select = c('ward', 'ward+', 'department', 'ward_type', 'institut'))
names(df_temp)[names(df_temp) == 'institut'] <- 'laboratory'
df_temp$ward_type <- tolower(df_temp$ward_type)
df_temp$ward <- tolower(df_temp$ward)
# Filter unique ward and add laboratory identifier
df_temp <- df_temp[!duplicated(df_temp$ward), ]
ward_list[[as.character(lab)]] <- df_temp
}, error = function(e) {
warning(paste("Sheet", lab, "not found or could not be read:", e$message))
})
}
# Combine all ward data into one dataframe
df_ward_combined <- do.call(rbind, ward_list)
# Merge with main dataframe based on both ward and laboratory
df_clean <- merge(df_clean, df_ward_combined,
by = c('ward', 'laboratory'),
all.x = TRUE)
df_ghru_kpn_result_clean <- df_clean
# AST Result ----------------------------------------------------------------
# Identify Neonates isolates
neo_age <- c("0", "1d", "2d", "3d", "4d", "5d", "6d", "7d", "8d", "9d", "10d", "11d", "12d", "13d", "14d"
, "15d", "16d", "17d", "18d", "19d", "20d", "21d", "22d", "23d", "24d", "25d", "26d", "27d", "28d")
carba_cols <- c("etp_nd10_ris","etp_nm_ris","ipm_nd10_ris", "ipm_nm_ris", "mem_nd10_ris","mem_nm_ris")
df_ghru_kpn_result1 <- df_ghru_kpn_result_clean %>%
mutate(
ast_result = case_when(
# Priority: any "R" → R
rowSums(across(all_of(carba_cols), ~ .x == "R"), na.rm = TRUE) > 0 ~ "R",
# All non-NA values are "S" and not all are NA
rowSums(across(all_of(carba_cols), ~ .x == "S"), na.rm = TRUE) ==
rowSums(!is.na(across(all_of(carba_cols)))) &
rowSums(!is.na(across(all_of(carba_cols)))) > 0 ~ "S",
# Map confirmed_ast to S if applicable
confirmed_ast %in% c("KPN: Carbapenem Susceptible", "KPN: PAN Susceptible") ~ "S",
# Map abx_resistant to R if applicable
grepl("CARBA", abx_resistant)  ~ "R",
TRUE ~ NA_character_
),
neonates = if_else(age %in% neo_age, "Yes", ""),
ast = case_when(
ast_result == "R" & neonates == "Yes" ~ "R_NEO",
ast_result == "S" & neonates == "Yes" ~ "S_NEO",
TRUE ~ ast_result
)
) %>%
select(-ast_result) %>%
arrange(accession_no)
# Filter Spec Date ----------------------------------------------------------------
kpn_valid_specdate <- c("2024-09","2024-10","2024-11","2024-12","2025-01", "2025-02", "2025-03", "2025-04", "2025-05", "2025-06")
# Identify if KPN Result for All ages is valid based on specimen date
df_ghru_kpn_result1$accepted <- ifelse(
str_sub(df_ghru_kpn_result1$spec_date, 1, 7) %in% kpn_valid_specdate &
df_ghru_kpn_result1$ast %in% c("R", "S"), "Yes",
ifelse(is.na(df_ghru_kpn_result1$ast) | !df_ghru_kpn_result1$ast %in% c("R", "S"), "", "No"))
df_ghru_kpn_result1 <- df_ghru_kpn_result1 %>% filter(accepted != "No")
# Rename Antibiotic ----------------------------------------------------------------
# List all columns that ends with RIS
new_abx_cols <- c("czo", "czo_disk", "czo_nm","czo_mic",
"cro","cro_disk", "cro_nm", "cro_mic",
"amc", "amc_disk","amc_nm","amc_mic",
"sam", "sam_disk","sam_nm","sam_mic",
"tzp", "tzp_disk","tzp_nm","tzp_mic",
"gen", "gen_disk","gen_nm","gen_mic",
"cip", "cip_disk", "cip_nm","cip_mic",
"lev", "lev_disk", "lev_nm","lev_mic",
"sxt", "sxt_disk","sxt_nm","sxt_mic",
"fep", "fep_disk","fep_nm","fep_mic",
"etp", "etp_disk","etp_nm","etp_mic",
"ipm", "ipm_disk","ipm_nm","ipm_mic",
"mem", "mem_disk","mem_nm","mem_mic",
"tob", "tob_disk","tob_nm","tob_mic",
"amk", "amk_disk","amk_nm","amk_mic",
"ctt", "ctt_disk","ctt_nm","ctt_mic",
"fox", "fox_disk","fox_nm","fox_mic",
"tcy", "tcy_disk","tcy_nm","tcy_mic",
"fdc", "fdc_disk","fdc_nm","fdc_mic",
"cza", "cza_disk","cza_nm","cza_mic",
"imr", "imr_disk","imr_nm","imr_mic",
"mev", "mev_disk","mev_nm","mev_mic",
"plz", "plz_disk","plz_nm","plz_mic",
"atm", "atm_disk","atm_nm","atm_mic",
"cpt", "cpt_disk","cpt_nm","cpt_mic",
"caz", "caz_disk","caz_nm","caz_mic",
"czt", "czt_disk","czt_nm","czt_mic",
"cxa", "cxa_disk","cxa_nm","cxa_mic",
"tgc", "tgc_disk","tgc_nm","tgc_mic",
"fos","fos_disk", "fos_nm","fos_mic",
"amp","amp_disk", "amp_nm", "amp_mic",
"ctx", "ctx_disk", "ctx_nm", "ctx_mic",
"col", "col_disk", "col_nm", "col_mic",
"dor", "dor_disk", "dor_nm", "dor_mic",
"nal", "nal_disk", "nal_nm", "nal_mic",
"nit", "nit_disk","nit_nm", "nit_mic")
# Keep only names that exist in df
valid <- abx_cols %in% names(df_ghru_kpn_result1)
names(df_ghru_kpn_result1)[match(abx_cols[valid], names(df_ghru_kpn_result1))] <- new_abx_cols[valid]
write_csv(df_ghru_kpn_result1, "df_ghru_kpn_result.csv")
# Summarize Result per Lab Code ----------------------------------------------------------------
GHRU_KPN_results <- bind_rows(
lapply(ghru_lab_code, function(site) {
lab_df <- df_ghru_kpn_result1 %>%
filter(laboratory == site) %>%
arrange(wgs_file)
r <- filter(lab_df, ast == "R") %>% head(10)
s <- filter(lab_df, ast == "S") %>% head(10)
rneo <- filter(lab_df, ast == "R_NEO") %>% head(10)
n_rneo <- nrow(rneo)
sneo <- filter(lab_df, ast == "S_NEO") %>% head(10)
n_sneo <- nrow(sneo)
r_total <- nrow(r) + n_rneo
s_total <- nrow(s) + n_sneo
if (r_total >= 10 & n_rneo >= 10){
r_filtered <- r %>%
slice_head(n = 5)
} else {
r_diff <- r_total - 10
r_filtered <- r %>%
slice_head(n = nrow(r) - r_diff)
}
if (s_total >= 10 & n_sneo >= 10){
s_filtered <- s %>%
slice_head(n = 5)
} else {
s_diff <- s_total - 10
s_filtered <- s %>%
slice_head(n = nrow(s) - s_diff)
}
# Create list of data frames to bind
result_list <- list(
"R"      = r_filtered,
"S"      = s_filtered,
"R_NEO"  = rneo,
"S_NEO"  = sneo,
"No_AST" = filter(lab_df, is.na(ast)) %>% head(10)
)
bind_rows(result_list, .id = "ast_result")
})
) %>%
filter(spec_type %in% c("bl", "csf")) %>%
arrange(accession_no) %>%
select(-accepted, -`ward+`, -ward_type) %>%
relocate(laboratory, .after = accession_no) %>%
relocate(laboratory_name, .after = laboratory) %>%
relocate(ward, .after = date_admis) %>%
relocate(department, .after = ward)
ward_type <- unique(GHRU_KPN_results$department)
# Recode Department code
GHRU_KPN_results <- GHRU_KPN_results %>%
mutate(department = recode(department,
"med" = "Medicine",
"icu" = "ICU",
"pic" = "ICU",
"sur" = "Surgery",
"neo" = "NICU",
"eme" = "Emergency",
"inf" = "Others",
"out" = "Outpatient",
"ped" = "Pedia",
"mix" = "Mix",
"unk" = "Unknown",
"obg" = "Ob-Gyn"
))
#GHRU_KPN_results <- GHRU_KPN_results %>%
#  filter(accession_no %in% ghru_ac)
write_csv(GHRU_KPN_results, "GHRU_KPN_results.csv")
ghru_sheet_id <- "1u5Nnl7dWqvKmfhw3Nfz7Txwm5d4X3Im19G8YHwn6el4"
# rewrite googlesheet "kpn_ghru_08042025" tab
sheet_write(ss = ghru_sheet_id, sheet = "linelist", data = GHRU_KPN_results)
# Load package
library(tidyverse)     # includes readr and purrr
library(readxl)        # for reading Excel files
library(writexl)       # for writing Excel files
library(conflicted)    # for resolving function conflicts
library(data.table)    # for fast data manipulation
library(googlesheets4) # for interacting with Google Sheets
library(lubridate)     # for handling date/time
conflicts_prefer(dplyr::filter)
# lab monitoring data ----------------------------------------------------------------
setwd("E:/DMU Projects/project_ghru")
# Read Laboratory Referred Isolates and SatScan Monitoring
lab_monitoring_sheet_id <- "1q6G-aonU7XZTDJ7Nwl7TbwBKk_V6csOdi1owLZPSi6Y"
# Read the sheet
df_lab_monitoring_sheet <- read_sheet(lab_monitoring_sheet_id, sheet = "Updated: Complete Monitoring (BENCH A AND MBL)")
# Select and rename columns
df_lab_monitoring <- df_lab_monitoring_sheet %>%
rename(
referred_ref_num = `Ref #`,
accession_no = `Referral Site_Acc #\n(Concatenated)\n\n(Do not encode)`,
year = `Year`,
date_received = `Date Received\n(dd-Mmm-yy)\n\n(Manual Encode)`,
laboratory = `Referral Site\n(XXX)\n\n(Manual Encode)`,
referred_ast = `Referred AST (Based from the criteria)`,
confirmed_id = `Confirmed Bacterial ID`,
confirmed_age = `Confirmed Age group (FOR KPN ONLY)`,
confirmed_ast = `Confirmed AST \n(Based from the Criteria)`,
abx_resistant = `Resistant to\n(ABx WHOnet CODE)...15`,
status = `Status`,
mbl = `Proceed to MBL`,
ssr = `Structured Survey\n(SSR)`
) %>%
select(
referred_ref_num, accession_no, year, date_received, referred_ast, confirmed_id,
confirmed_age, confirmed_ast, abx_resistant, status, mbl, ssr
) %>%
filter(confirmed_id == "KPN" & ssr == "Yes")
# MBL SSR monitoring ----------------------------------------------------------------
# Read Laboratory MBL Structured Survey monitoring
ssr_monitoring_sheet_id <- "1YlSxB_cbhvBpXMbsfm2lA9afAD4feMUGMkEisbNQC4U"
# Read the sheet
df_ssr_monitoring_sheet <- read_sheet(ssr_monitoring_sheet_id, sheet = "MONITORING")
# Select and rename columns
df_ssr_monitoring <- df_ssr_monitoring_sheet %>%
slice(-1) %>%
rename(
SSR_sample_no = `Sample no.`,
accession_no = `Accession No.`,
organism = `Organism`,
extraction_date = `Extraction Date`,
sequencing_date = `Sequencing Date`,
result = Result...12
) %>%
select(
SSR_sample_no, accession_no, organism, extraction_date, sequencing_date, result
) %>%
mutate(organism = toupper(organism)) %>%
filter(organism == "KPN") %>%
filter(!SSR_sample_no %in% c("SSR454", "SSR455"))
# Merge lab referred monitoring and MBL SSR monitoring ----------------------------------------------------------------
ghru_lab_code <- c("BGH","BRH","BRT","CMC","CRH","CVM","DMC","EVR","GMH","JLM","MAR","MMH","NKI","NMC","SLH","STU","VSM","ZMC")
df_lab_kpn_monitoring <- merge(df_lab_monitoring, df_ssr_monitoring, by = "accession_no", all = TRUE) %>%
mutate(laboratory = str_extract(accession_no, "(?<=_).{3}")) %>%
filter(laboratory %in% ghru_lab_code)
# List accession number
ac_list <- df_lab_kpn_monitoring$accession_no
# WGS QC Result ----------------------------------------------------------------
sheet_id <- "1NHu-RIgDeTPKgrnTTHS9qVbCe04tIeYX6k73Jm93gDw"
# Read the sheet
df_result <- read_sheet(sheet_id, sheet = "result")
#remove batch name in sample_id
df_result_subset <- df_result %>%
mutate(
wgs_file = sample_id,
sample_id = case_when(
str_count(sample_id, "_") == 4 ~ sub("^([^_]+_[^_]+_[^_]+_[^_]+)_.*$", "\\1", sample_id),
str_count(sample_id, "_") == 3 ~ sub("^([^_]+_[^_]+_[^_]+)_.*$", "\\1", sample_id),
str_count(sample_id, "_") == 2 ~ sub("^(([^_]+_[^_]+)).*", "\\1", sample_id),
TRUE ~ sample_id  # Default case (keep original)
)
) %>%
rename(
accession_no = sample_id
) %>%
filter(
accession_no %in% ac_list
)
df_wgs_result <- df_result_subset %>%
# Group by accession_no to combine multiple batches
group_by(accession_no) %>%
# For each group, create comma-separated list of batch codes
mutate(batch_codes = paste(unique(batch_code), collapse = ", ")) %>%
# Arrange by results to ensure "Passed" comes last (if multiple)
arrange(results, .by_group = TRUE) %>%
# Keep only rows where the result is "Passed"
# Or if no "Passed" exists, keep the existing result
filter(results == "Passed" |
(results != "Passed" & !any(results == "Passed"))) %>%
# Take the last record (which will be the last "Passed" if multiple exist)
slice_tail(n = 1) %>%
ungroup() %>%
# Select and rename columns to match expected output
#select(accession_no, wgs_file, wgs_id, batch_codes, results = results) %>%
# Arrange by accession_no (optional, to match exact order in example)
arrange(accession_no)
# Referred Demogs ----------------------------------------------------------------
referred_sheet_id <- "1JKtyRyLh0-ck2xCk0oIH4iidgs21996UKj69lvvlXAU"
# Read the sheet
df_referred_raw <- read_sheet(referred_sheet_id, sheet = 1)
demogs_cols <- c("accession_no", "date_birth", "age", "sex", "referral_date", "arsrl_org", "spec_type", "spec_date","date_admis", "ward", "service_type")
# List all columns that ends with RIS
abx_cols <- c("czo_nd30", "czo_nd30_ris", "czo_nm","czo_nm_ris",
"cro_nd30","cro_nd30_ris", "cro_nm", "cro_nm_ris",
"amc_nd20", "amc_nd20_ris","amc_nm","amc_nm_ris",
"sam_nd10", "sam_nd10_ris","sam_nm","sam_nm_ris",
"tzp_nd100", "tzp_nd100_ris","tzp_nm","tzp_nm_ris",
"gen_nd10", "gen_nd10_ris","gen_nm","gen_nm_ris",
"cip_nd5", "cip_nd5_ris", "cip_nm","cip_nm_ris",
"lev_nd5", "lev_nd5_ris", "lev_nm","lev_nm_ris",
"sxt_nd12", "sxt_nd12_ris","sxt_nm","sxt_nm_ris",
"fep_nd30", "fep_nd30_ris","fep_nm","fep_nm_ris",
"etp_nd10", "etp_nd10_ris","etp_nm","etp_nm_ris",
"ipm_nd10", "ipm_nd10_ris","ipm_nm","ipm_nm_ris",
"mem_nd10", "mem_nd10_ris","mem_nm","mem_nm_ris",
"tob_nd10", "tob_nd10_ris","tob_nm","tob_nm_ris",
"amk_nd30", "amk_nd30_ris","amk_nm","amk_nm_ris",
"ctt_nd30", "ctt_nd30_ris","ctt_nm","ctt_nm_ris",
"fox_nd30", "fox_nd30_ris","fox_nm","fox_nm_ris",
"tcy_nd30", "tcy_nd30_ris","tcy_nm","tcy_nm_ris",
"fdc_nd", "fdc_nd_ris","fdc_nm","fdc_nm_ris",
"cza_nd30", "cza_nd30_ris","cza_nm","cza_nm_ris",
"imr_nd10", "imr_nd10_ris","imr_nm","imr_nm_ris",
"mev_nd20", "mev_nd20_ris","mev_nm","mev_nm_ris",
"plz_nd", "plz_nd_ris","plz_nm","plz_nm_ris",
"atm_nd30", "atm_nd30_ris","atm_nm","atm_nm_ris",
"cpt_nd30", "cpt_nd30_ris","cpt_nm","cpt_nm_ris",
"caz_nd30", "caz_nd30_ris","caz_nm","caz_nm_ris",
"czt_nd30", "czt_nd30_ris","czt_nm","czt_nm_ris",
"cxa_nd30", "cxa_nd30_ris","cxa_nm","cxa_nm_ris",
"tgc_nd15", "tgc_nd15_ris","tgc_nm","tgc_nm_ris",
"fos_nd200","fos_nd200_ris", "fos_nm","fos_nm_ris",
"amp_nd10","amp_nd10_ris", "amp_nm", "amp_nm_ris",
"ctx_nd30", "ctx_nd30_ris", "ctx_nm", "ctx_nm_ris",
"col_nd10", "col_nd10_ris", "col_nm", "col_nm_ris",
"dor_nd10", "dor_nd10_ris", "dor_nm", "dor_nm_ris",
"nal_nd30", "nal_nd30_ris", "nal_nm", "nal_nm_ris",
"nit_nd300", "nit_nd300_ris","nit_nm", "nit_nm_ris")
#column name will be stored in a vector if the column is present in the result database
cols_present <- colnames(df_referred_raw[,intersect(abx_cols, colnames(df_referred_raw))])
cols_to_retain <- append(demogs_cols, cols_present)
# Subset df_referred_raw
df_referred_demogs <- subset(df_referred_raw, select = cols_to_retain) %>%
filter(accession_no %in% ac_list)
# Merge Demogs and WGS QC Result ----------------------------------------------------------------
df_kpn_wgs_demogs <- merge(df_referred_demogs, df_wgs_result, by = "accession_no", all = TRUE) %>%
relocate(wgs_file, batch_codes, results, .before = date_birth)
# Merge df_lab_kpn_monitoring and df_wgs_result ----------------------------------------------------------------
df_ghru_kpn_result <- merge(df_lab_kpn_monitoring, df_kpn_wgs_demogs, by = "accession_no", all = TRUE) %>%
rename(
wgs_result = results,
sequencing_result = result
) %>%
select(-year, -confirmed_id, -confirmed_age, -referred_ast, -extraction_date)
#edit format
df_ghru_kpn_result$date_received <- format(as.Date(df_ghru_kpn_result$date_received), "%Y-%m-%d")
df_ghru_kpn_result$sequencing_date <- format(as.Date(df_ghru_kpn_result$sequencing_date), "%Y-%m-%d")
df_ghru_kpn_result$referral_date <- format(as.Date(df_ghru_kpn_result$referral_date), "%Y-%m-%d")
# Add Laboratory Name ------------------------------------------
site_code <- c(
'APM' = 'Amai Pakpak Medical Center',
'BGH' = 'Baguio General Hospital and Medical Center',
'BRH' = 'Batangas Medical Center',
'BRT' = 'Bicol Regional Hospital and Medical Center',
'CMC' = 'Cotabato Regional Hospital and Medical Center',
'CRH' = 'Caraga Regional Hospital',
'CVM' = 'Cagayan Valley Medical Center',
'DLS' = 'De La Salle University Medical Center',
'DMC' = 'Southern Philippines Medical Center',
'EVR' = 'Eastern Visayas Medical Center',
'FEU' = 'FEU - NRMF Medical Center',
'GMH' = 'Gov. Celestino Gallares Memorial Regional Hospital',
'JLM' = 'Jose B. Lingad Memorial Regional Hospital',
'LCP' = 'Lung Center of the Philippines',
'MAR' = 'Mariano Marcos Memorial Hospital and Medical Center',
'MMH' = 'Corazon Locsin Montelibano Memorial Regional Hospital',
'NKI' = 'National Kidney and Transplant Institute',
'NMC' = 'Northern Mindanao Medical Center',
'ONP' = 'Ospital ng Palawan',
'PGH' = 'Philippine General Hospital',
'RMC' = 'Rizal Medical Center',
'RTH' = 'Dr. Rafael S. Tumbokon Memorial Hospital',
'RTM' = 'Research Institute for Tropical Medicine',
'SLH' = 'San Lazaro Hospital',
'STU' = 'University of Sto. Tomas Hospital',
'VSM' = 'Vicente Sotto Memorial Medical Center',
'ZMC' = 'Zamboanga City Medical Center',
'ZPH' = 'Zamboanga del Norte Medical Center'
)
df_ghru_kpn_result$laboratory_name <- site_code[df_ghru_kpn_result$laboratory]
# Add new columns based on condition ------------------------------------------
df_ghru_kpn_result$sex <- ifelse(df_ghru_kpn_result$sex == "f", "Female", "Male")
df_ghru_kpn_result$service_type <- ifelse(df_ghru_kpn_result$service_type == "In", "Inpatient", "Outpatient")
# Clean Ward Type Value ------------------------------------------
df_clean <- df_ghru_kpn_result
# Get unique laboratory values
unique_labs <- unique(df_clean$laboratory)
# Initialize an empty list to store ward data from each sheet
ward_list <- list()
# Loop through each laboratory value and read the corresponding sheet
for (lab in unique_labs) {
tryCatch({
# Read the sheet with the name matching the laboratory value
df_temp <- read_excel("2024_DATA_ward.xlsx", sheet = as.character(lab))
# Select required columns
df_temp <- subset(df_temp, select = c('ward', 'ward+', 'department', 'ward_type', 'institut'))
names(df_temp)[names(df_temp) == 'institut'] <- 'laboratory'
df_temp$ward_type <- tolower(df_temp$ward_type)
df_temp$ward <- tolower(df_temp$ward)
# Filter unique ward and add laboratory identifier
df_temp <- df_temp[!duplicated(df_temp$ward), ]
ward_list[[as.character(lab)]] <- df_temp
}, error = function(e) {
warning(paste("Sheet", lab, "not found or could not be read:", e$message))
})
}
# Combine all ward data into one dataframe
df_ward_combined <- do.call(rbind, ward_list)
# Merge with main dataframe based on both ward and laboratory
df_clean <- merge(df_clean, df_ward_combined,
by = c('ward', 'laboratory'),
all.x = TRUE)
df_ghru_kpn_result_clean <- df_clean
# AST Result ----------------------------------------------------------------
# Identify Neonates isolates
neo_age <- c("0", "1d", "2d", "3d", "4d", "5d", "6d", "7d", "8d", "9d", "10d", "11d", "12d", "13d", "14d"
, "15d", "16d", "17d", "18d", "19d", "20d", "21d", "22d", "23d", "24d", "25d", "26d", "27d", "28d")
carba_cols <- c("etp_nd10_ris","etp_nm_ris","ipm_nd10_ris", "ipm_nm_ris", "mem_nd10_ris","mem_nm_ris")
df_ghru_kpn_result1 <- df_ghru_kpn_result_clean %>%
mutate(
ast_result = case_when(
# Priority: any "R" → R
rowSums(across(all_of(carba_cols), ~ .x == "R"), na.rm = TRUE) > 0 ~ "R",
# All non-NA values are "S" and not all are NA
rowSums(across(all_of(carba_cols), ~ .x == "S"), na.rm = TRUE) ==
rowSums(!is.na(across(all_of(carba_cols)))) &
rowSums(!is.na(across(all_of(carba_cols)))) > 0 ~ "S",
# Map confirmed_ast to S if applicable
confirmed_ast %in% c("KPN: Carbapenem Susceptible", "KPN: PAN Susceptible") ~ "S",
# Map abx_resistant to R if applicable
grepl("CARBA", abx_resistant)  ~ "R",
TRUE ~ NA_character_
),
neonates = if_else(age %in% neo_age, "Yes", ""),
ast = case_when(
ast_result == "R" & neonates == "Yes" ~ "R_NEO",
ast_result == "S" & neonates == "Yes" ~ "S_NEO",
TRUE ~ ast_result
)
) %>%
select(-ast_result) %>%
arrange(accession_no)
# Filter Spec Date ----------------------------------------------------------------
kpn_valid_specdate <- c("2024-09","2024-10","2024-11","2024-12","2025-01", "2025-02", "2025-03", "2025-04", "2025-05", "2025-06")
# Identify if KPN Result for All ages is valid based on specimen date
df_ghru_kpn_result1$accepted <- ifelse(
str_sub(df_ghru_kpn_result1$spec_date, 1, 7) %in% kpn_valid_specdate &
df_ghru_kpn_result1$ast %in% c("R", "S"), "Yes",
ifelse(is.na(df_ghru_kpn_result1$ast) | !df_ghru_kpn_result1$ast %in% c("R", "S"), "", "No"))
write_csv(df_ghru_kpn_result1, "df_ghru_kpn_result.csv")
df_ghru_kpn_result2 <- df_ghru_kpn_result1 %>% filter(accepted != "No")
write_csv(df_ghru_kpn_result2, "df_ghru_kpn_result2.csv")
